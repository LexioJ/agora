<!--
  - SPDX-FileCopyrightText: 2024 Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script setup>
import { ref, onMounted } from 'vue'
import { t } from '@nextcloud/l10n'
import NcButton from '@nextcloud/vue/components/NcButton'
import NcInputField from '@nextcloud/vue/components/NcInputField'
import NcSelect from '@nextcloud/vue/components/NcSelect'
import { useAppSettingsStore } from '../../../stores/appSettings.ts'
import { InquiryGeneralIcons } from '../../../utils/icons.ts'

const appSettingsStore = useAppSettingsStore()
const editingFamily = ref(null)
const newFamily = ref({
  family_type: '',
  label: '',
  description: '',
  icon: '',
  sort_order: 0
})

onMounted(() => {
})

const availableIcons = [
  { id: 'account-group', label: t('agora', 'Group') },
  { id: 'briefcase', label: t('agora', 'Business') },
  { id: 'chart-bar', label: t('agora', 'Analytics') },
  { id: 'chat', label: t('agora', 'Discussion') },
  { id: 'vote', label: t('agora', 'Vote') },
]

const addFamily = async () => {
  if (!newFamily.value.family_type || !newFamily.value.label) return
  
  await appSettingsStore.addFamily({
    ...newFamily.value,
    created: Date.now()
  })
  
  // Reset form
  newFamily.value = {
    family_type: '',
    label: '',
    description: '',
    icon: '',
    sort_order: appSettingsStore.inquiryFamilyTab.length
  }
}

const updateFamily = async (family) => {
  await appSettingsStore.updateFamily(family.id, family)
  editingFamily.value = null
}

const deleteFamily = async (familyId) => {
  if (confirm(t('agora', 'Are you sure you want to delete this family?'))) {
    await appSettingsStore.deleteFamily(familyId)
  }
}
</script>

<template>
  <div class="inquiry-families">
    <h2>{{ t('agora', 'Inquiry Families') }}</h2>
    <p class="description">
      {{ t('agora', 'Manage inquiry families to organize different types of inquiries') }}
    </p>

    <!-- Liste des familles existantes -->
    <div class="families-list">
      <div v-for="family in appSettingsStore.inquiryFamilyTab" :key="family.id" class="family-item">
        <div class="family-content">
          <div class="family-icon">
            <span class="icon">{{ family.icon }}</span>
          </div>
          <div class="family-info">
            <h4>{{ family.label }}</h4>
            <p class="family-type">{{ family.family_type }}</p>
            <p v-if="family.description" class="family-description">
              {{ family.description }}
            </p>
          </div>
        </div>
        <div class="family-actions">
          <NcButton @click="editingFamily = { ...family }">
            {{ t('agora', 'Edit') }}
          </NcButton>
          <NcButton @click="deleteFamily(family.id)">
            {{ t('agora', 'Delete') }}
          </NcButton>
        </div>
      </div>
    </div>

    <!-- Formulaire d'ajout -->
    <div class="add-family-form">
      <h3>{{ t('agora', 'Add New Family') }}</h3>
      <div class="form-grid">
        <NcInputField
          v-model="newFamily.family_type"
          :label="t('agora', 'Family Type Key')"
          :placeholder="t('agora', 'e.g., deliberative, consultative')"
          required
        />
        
        <NcInputField
          v-model="newFamily.label"
          :label="t('agora', 'Display Label')"
          :placeholder="t('agora', 'e.g., Deliberative Process')"
          required
        />
        
        <NcInputField
          v-model="newFamily.description"
          :label="t('agora', 'Description')"
          :placeholder="t('agora', 'Optional description')"
          type="textarea"
        />
        
        <NcSelect
          v-model="newFamily.icon"
          :options="availableIcons"
          :label="t('agora', 'Icon')"
        />
        
        <NcInputField
          v-model="newFamily.sort_order"
          :label="t('agora', 'Sort Order')"
          type="number"
        />
        
        <NcButton 
          type="primary" 
          :disabled="!newFamily.family_type || !newFamily.label"
          @click="addFamily"
        >
          {{ t('agora', 'Add Family') }}
        </NcButton>
      </div>
    </div>

    <!-- Modal d'Ã©dition -->
    <div v-if="editingFamily" class="modal-overlay">
      <div class="modal-content">
        <h3>{{ t('agora', 'Edit Family') }}</h3>
        <div class="form-grid">
          <NcInputField
            v-model="editingFamily.family_type"
            :label="t('agora', 'Family Type Key')"
            required
          />
          <NcInputField
            v-model="editingFamily.label"
            :label="t('agora', 'Display Label')"
            required
          />
          <NcInputField
            v-model="editingFamily.description"
            :label="t('agora', 'Description')"
            type="textarea"
          />
          <NcSelect
            v-model="editingFamily.icon"
            :options="availableIcons"
            :label="t('agora', 'Icon')"
          />
          <div class="modal-actions">
            <NcButton @click="editingFamily = null">
              {{ t('agora', 'Cancel') }}
            </NcButton>
            <NcButton 
              type="primary" 
              @click="updateFamily(editingFamily)"
            >
              {{ t('agora', 'Save') }}
            </NcButton>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.inquiry-families {
  padding: 20px;
}

.families-list {
  margin-bottom: 30px;
}

.family-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  margin-bottom: 10px;
  background: var(--color-background-dark);
  border-radius: 8px;
}

.family-content {
  display: flex;
  align-items: center;
  gap: 15px;
}

.family-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-primary);
  color: white;
  border-radius: 8px;
  font-size: 20px;
}

.family-info h4 {
  margin: 0 0 5px 0;
}

.family-type {
  margin: 0;
  font-family: monospace;
  color: var(--color-text-lighter);
  font-size: 0.9em;
}

.family-description {
  margin: 5px 0 0 0;
  color: var(--color-text-lighter);
}

.family-actions {
  display: flex;
  gap: 10px;
}

.add-family-form {
  padding: 20px;
  background: var(--color-background-dark);
  border-radius: 8px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--color-main-background);
  padding: 30px;
  border-radius: 12px;
  width: 500px;
  max-width: 90%;
}

.modal-actions {
  grid-column: span 2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}
</style>
