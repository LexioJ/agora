<!--
- SPDX-FileCopyrightText: 2025 Nextcloud contributors
- SPDX-License-Identifier: AGPL-3.0-or-later
-->

<template>
  <NcAppContent class="inquiry-group-page">
    <div class="inquiry-group-page">
      <!-- Breadcrumb -->
      <div class="breadcrumb-bar theme-dark">
        <div class="breadcrumb-container">
          <!-- Home Button -->
          <NcButton 
            type="tertiary"
            class="breadcrumb-home"
            @click="navigateToHome"
          >
            <template #icon>
                <component :is="InquiryGeneralIcons.Home" :size="20"/>
            </template>
            <span class="breadcrumb-label">{{ t('agora', 'Home') }}</span>
          </NcButton>
          
          <!-- Parent groups -->
          <template v-for="(parent, index) in parentGroups" :key="parent.id">
            <div class="breadcrumb-separator">‚ùØ</div>
            <NcButton 
              type="tertiary"
              class="breadcrumb-item"
              @click="selectGroup(parent)"
            >
              <div class="breadcrumb-item-content">
                  <component
                    :is="getGroupTypeIconComponent(parent.type)"
                    class="breadcrumb-icon"
                  />
                  <span class="breadcrumb-label">{{ parent.title }}</span>
              </div>
            </NcButton>
          </template>

          <!-- Current group or type -->
          <div v-if="hasSlug || parentGroups.length > 0" class="breadcrumb-separator">‚ùØ</div>
          <div class="breadcrumb-current">
              <div class="breadcrumb-current-content">
                  <component
                    :is="currentIconComponent"
                    class="breadcrumb-icon"
                  />
                  <span class="breadcrumb-label">{{ currentBreadcrumbTitle }}</span>
                  <span v-if="totalInquiries > 0 && hasSlug" class="inquiry-count">
                      ({{ totalInquiries }})
                  </span>
                  <span v-else-if="displayedGroups.length > 0 && !hasSlug" class="inquiry-count">
                      ({{ displayedGroups.length }})
                  </span>
              </div>
          </div>
        </div>
      </div>

      <!-- White Separation Line -->
      <div class="separation-line"></div>

      <!-- Main Content -->
      <div v-if="!groupNotFound">
        <!-- Header Section -->
        <div class="group-header">
            <div class="header-left">
                <div class="group-icon-badge">
                    <component
                      :is="currentIconComponent"
                      class="group-icon"
                    />
                </div>
                <div class="group-title-section">
                    <h1 class="group-title">{{ currentTitle }}</h1>
                    <div class="group-subtitle">
                        <p>{{ currentDescription }}</p>
                        <span v-if="totalInquiries > 0 && hasSlug" class="inquiry-count-badge">
                            {{ totalInquiries }} {{ t('agora', 'inquiries') }}
                        </span>
                        <span v-if="displayedGroups.length > 0 && !hasSlug" class="groups-count-badge">
                            {{ displayedGroups.length }} {{ t('agora', 'groups') }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="isLoading" class="loading-state">
            <div class="spinner"></div>
            <p>{{ t('agora', 'Loading...') }}</p>
        </div>

        <!-- Content when loaded -->
        <div v-else class="content-area">
          <!-- Section Header -->
          <div class="section-header">
            <h3>{{ sectionTitle }}</h3>
            <div class="section-actions" v-if="isOwnerOrAdmin">
              <NcButton class="create-button" @click="createInquiryGroup(currentGroupType)">
                ‚ûï {{ t('agora', 'Create Group') }}
              </NcButton>
            </div>
          </div>

          <!-- Groups Grid -->
          <div v-if="displayedGroups.length > 0" class="groups-grid">
            <div 
              v-for="group in displayedGroups" 
              :key="group.id"
              class="group-vignette-wrapper"
              @mouseenter="hoveredGroupId = group.id"
              @mouseleave="hoveredGroupId = null"
            >
              <div class="group-vignette" @click="selectGroup(group)">
                <div v-if="group.coverId" class="vignette-cover">
                  <img :src="getCoverUrl(group.coverId)" :alt="group.title" />
                  <div class="vignette-cover-overlay"></div>
                </div>
                <div class="vignette-content">
                  <div class="vignette-icon">
                    <component
                      :is="getGroupTypeIconComponent(group.type)"
                    />
                  </div>
                  <h4>{{ group.title }}</h4>
                  <p v-if="group.description" class="vignette-description">
                    {{ truncateText(group.description, 100) }}
                  </p>
                  <div class="vignette-stats">
                    <div class="stat-item">
                      <span class="stat-icon">üìù</span>
                      <span class="stat-value">{{ group.inquiryIds?.length || 0 }}</span>
                    </div>
                    <div v-if="getGroupChildren(group).length > 0" class="stat-item">
                      <span class="stat-icon">üë•</span>
                      <span class="stat-value">{{ getGroupChildren(group).length }}</span>
                    </div>
                  </div>
                  <div class="vignette-footer">
                    <NcButton class="view-group-button" @click.stop="selectGroup(group)">
                      {{ t('agora', 'View Group') }}
                      <template #icon>
                        <svg width="16" height="16" viewBox="0 0 24 24">
                          <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                        </svg>
                      </template>
                    </NcButton>
                  </div>
                </div>
              </div>
              
              <!-- Owner menu (appears under the vignette on hover) -->
              <div 
                v-if="group.slug && isOwnerOrAdmin && hoveredGroupId === group.id" 
                class="owner-menu-under"
                @mouseenter="hoveredGroupId = group.id"
                @mouseleave="hoveredGroupId = null"
              >
                <div class="owner-menu-content">
                  <NcButton 
                    type="tertiary" 
                    class="menu-item modify"
                    @click.stop="modifyGroup(group)"
                  >
                    <template #icon>
                      <svg width="14" height="14" viewBox="0 0 24 24">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                      </svg>
                    </template>
                    {{ t('agora', 'Modify') }}
                  </NcButton>
                  
                  <NcButton 
                    type="tertiary" 
                    class="menu-item delete"
                    @click.stop="deleteGroup(group)"
                  >
                    <template #icon>
                      <svg width="14" height="14" viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </template>
                    {{ t('agora', 'Delete') }}
                  </NcButton>
                  
                  <NcButton 
                    type="tertiary" 
                    class="menu-item add-response"
                    @click.stop="addAllowedResponse(group)"
                  >
                    <template #icon>
                      <svg width="14" height="14" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                      </svg>
                    </template>
                    {{ t('agora', 'Add Response') }}
                  </NcButton>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div v-else class="empty-state">
            <div class="empty-icon">üìù</div>
            <h3>{{ emptyStateTitle }}</h3>
            <p>{{ emptyStateMessage }}</p>
            <NcButton v-if="hasSlug" @click="navigateToCreateInquiry()" type="primary">
              ‚ûï {{ t('agora', 'Create First Inquiry') }}
            </NcButton>
            <NcButton v-else-if="isOwnerOrAdmin" @click="createInquiryGroup(currentGroupType)" type="primary">
              ‚ûï {{ t('agora', 'Create First Group') }}
            </NcButton>
          </div>
        </div>
      </div>

      <!-- Group not found -->
      <div v-else class="not-found-state">
        <div class="not-found-icon">üîç</div>
        <h2>{{ t('agora', 'Group not found') }}</h2>
        <p>{{ t('agora', 'The group you are looking for does not exist or you do not have permission to access it.') }}</p>
        <NcButton @click="navigateToHome" type="primary">
          {{ t('agora', 'Back to home') }}
        </NcButton>
      </div>
    </div>
      <NcDialog
            v-if="createGroupDlgToggle"
            :name="t('agora', 'Create New Inquiry Group')"
            :enable-slide-up="false"
            @close="handleCloseGroupDialog"
            >
            <InquiryGroupCreateDlg
                    :inquiry-group-type="selectedInquiryGroupTypeForCreation"
                    :selected-groups="selectedGroups"
                    :available-groups="availableGroups"
                    @added="inquiryGroupAdded"
                    @close="handleCloseGroupDialog"
                    @update:selected-groups="selectedGroups = $event"
                    />
    </NcDialog>

    <NcDialog
    v-if="deleteDialogGroup"
    v-model:open="showDeleteDialog"
    :name="deleteDialogTitle"
    :message="deleteDialogMessage"
    :buttons="deleteDialogButtons"
  />

  </NcAppContent>
</template>

<script setup lang="ts">
import { computed, ref, onMounted, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { t } from '@nextcloud/l10n'
import { showError, showSuccess } from '@nextcloud/dialogs'
import NcAppContent from '@nextcloud/vue/components/NcAppContent'
import NcButton from '@nextcloud/vue/components/NcButton'
import NcDialog from '@nextcloud/vue/components/NcDialog'
import { useSessionStore } from '../stores/session.ts'
import { useInquiriesStore } from '../stores/inquiries.ts'
import { useInquiryGroupsStore } from '../stores/inquiryGroups.ts'
import { InquiryGeneralIcons } from '../utils/icons.ts'
import { getInquiryGroupTypeData, truncateText } from '../helpers/modules/InquiryHelper.ts'
import InquiryGroupCreateDlg from '../components/Create/InquiryGroupCreateDlg.vue'
import type { InquiryGroupType, IInquiryGroup } from '../stores/inquiryGroups.types.ts'

const route = useRoute()
const router = useRouter()
const sessionStore = useSessionStore()
const inquiriesStore = useInquiriesStore()
const inquiryGroupsStore = useInquiryGroupsStore()

const isLoading = ref(true)
const groupNotFound = ref(false)
const hoveredGroupId = ref<number | null>(null)
const selectedGroupForDialog = ref<any>(null)
const createDlgToggle = ref(false)
const createGroupDlgToggle = ref(false)
const selectedInquiryGroupTypeForCreation = ref<InquiryGroupType | null>(null)

// Delete dialog state
const showDeleteDialog = ref(false)
const deleteDialogGroup = ref<IInquiryGroup | null>(null)

// Check if we have a slug in the route
const hasSlug = computed(() => {
  const slug = route.params.slug as string
  return slug && slug !== 'none' && slug !== 'undefined' && slug !== ''
})

// Get current group type
const currentGroupType = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return currentInquiryGroup.value.type
  }
  return inquiryGroupsStore.currentGroupType || 'assembly'
})

// Get current group if slug exists
const currentInquiryGroup = computed(() => {
  if (!hasSlug.value) return null
  const slug = route.params.slug as string
  const group = inquiryGroupsStore.bySlug(slug)
  if (!group) {
    groupNotFound.value = true
  }
  return group
})

// Get parent groups for breadcrumb
const parentGroups = computed(() => {
  if (!currentInquiryGroup.value) return []
  
  const parents: IInquiryGroup[] = []
  let currentGroup = currentInquiryGroup.value
  
  // Build parent chain using parentId
  while (currentGroup.parentId) {
    const parent = inquiryGroupsStore.inquiryGroups.find(g => g.id === currentGroup.parentId)
    if (parent) {
      parents.unshift(parent)
      currentGroup = parent
    } else {
      break
    }
  }
  
  return parents
})

// Get groups to display
const displayedGroups = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    // Show child groups of current group
    const childGroups = inquiryGroupsStore.inquiryGroups.filter(
      group => group.parentId === currentInquiryGroup.value?.id
    )
    return childGroups.sort((a, b) => a.title.localeCompare(b.title))
  }
  
  // Show root groups of current type
  const rootGroups = inquiryGroupsStore.inquiryGroups.filter(
    group => !group.parentId && group.type === currentGroupType.value
  )
  return rootGroups.sort((a, b) => a.title.localeCompare(b.title))
})

// Get total inquiries for current group
const totalInquiries = computed(() => {
  if (!hasSlug.value || !currentInquiryGroup.value) return 0
  
  // Count inquiries belonging to this group
  return inquiriesStore.inquiries.filter(
    inquiry => inquiry.groupId === currentInquiryGroup.value?.id
  ).length
})

// Section title
const sectionTitle = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return t('agora', 'Subgroups')
  }
  return selectedTypeLabel.value
})

// Empty state titles
const emptyStateTitle = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return t('agora', 'No subgroups yet')
  }
  return t('agora', 'No groups yet')
})

const emptyStateMessage = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return t('agora', 'This group doesn\'t contain any subgroups yet.')
  }
  return t('agora', 'Create your first group to organize inquiries.')
})

// Check if user is owner or admin
const isOwnerOrAdmin = computed(() => {
  return sessionStore.isOwnerOrAdmin
})

// Get icon component for group type
const getGroupTypeIconComponent = (type: string) => {
  const typeData = getInquiryGroupTypeData(type, sessionStore.appSettings.inquiryGroupTypeTab)
  return typeData?.icon || 'div'
}

// Helper function to get children from inquiryGroupsStore[group.Id].childs
function getGroupChildren(group: IInquiryGroup) {
  if (!group || !group.id) return []
  
  // Try to get children from store structure
  const storeGroup = inquiryGroupsStore.inquiryGroups.find(g => g.id === group.id)
  if (storeGroup?.childs) {
    return storeGroup.childs
  }
  
  // Fallback to filtering by parentId
  const allGroups = inquiryGroupsStore.inquiryGroups || []
  return allGroups.filter(g => g.parentId === group.id)
}

// Current icon component
const currentIconComponent = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return getGroupTypeIconComponent(currentInquiryGroup.value.type)
  }
  return getGroupTypeIconComponent(currentGroupType.value)
})

// Get type data
const selectedTypeData = computed(() => {
  return getInquiryGroupTypeData(currentGroupType.value, sessionStore.appSettings.inquiryGroupTypeTab)
})

const selectedTypeLabel = computed(() => 
  selectedTypeData.value?.label ? t('agora', selectedTypeData.value.label) : t('agora', 'Assembly')
)

const selectedTypeDescription = computed(() => 
  selectedTypeData.value?.description ? t('agora', selectedTypeData.value.description) : t('agora', 'Browse available groups')
)

// Current title
const currentTitle = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return currentInquiryGroup.value.title || currentInquiryGroup.value.name
  }
  return selectedTypeLabel.value
})

// Current description
const currentDescription = computed(() => {
  if (hasSlug.value && currentInquiryGroup.value) {
    return currentInquiryGroup.value.description || selectedTypeDescription.value
  }
  return selectedTypeDescription.value
})

// Breadcrumb current title
const currentBreadcrumbTitle = computed(() => {
  return currentTitle.value
})

// Delete dialog properties
const deleteDialogTitle = computed(() => 
  deleteDialogGroup.value 
    ? t('agora', 'Delete "{group}"', { group: deleteDialogGroup.value.title })
    : t('agora', 'Delete Group')
)

const deleteDialogMessage = computed(() => 
  t('agora', 'Are you sure you want to delete this group? All subgroups and inquiries within it will also be deleted. This action cannot be undone.')
)

const deleteDialogButtons = computed(() => [
  {
    label: t('agora', 'Cancel'),
    type: 'secondary',
    callback: () => {
      showDeleteDialog.value = false
      deleteDialogGroup.value = null
    }
  },
  {
    label: t('agora', 'Delete'),
    type: 'error',
    callback: async () => {
      if (deleteDialogGroup.value) {
        await performDeleteGroup(deleteDialogGroup.value)
      }
      showDeleteDialog.value = false
      deleteDialogGroup.value = null
    }
  }
])

// Methods
function navigateToHome() {
  router.push({ name: 'group-list', params: { slug: 'none' }, query: {} })
}

function selectGroup(group: IInquiryGroup) {
  if (group.slug) {
    router.push({ name: 'group-list', params: { slug: group.slug } })
  }
}

function navigateToCreateInquiry() {
  router.push({
    name: 'menu',
    query: {
      viewMode: 'create',
      groupId: currentInquiryGroup.value?.id
    }
  })
}

// Function to create new inquiry group from type
function createInquiryGroup(inquiryGroupType: InquiryGroupType) {
  selectedInquiryGroupTypeForCreation.value = inquiryGroupType
  createGroupDlgToggle.value = true
}

// Cover URL helper
function getCoverUrl(coverId: string) {
  // Implement cover URL generation based on your API
  return `/api/cover/${coverId}`
}

// Truncate text helper (assuming it's imported from InquiryHelper)
// If not, define it locally:
function truncateText(text: string, maxLength: number): string {
  if (!text || text.length <= maxLength) return text
  return text.substring(0, maxLength - 3) + '...'
}

// Owner menu actions
function modifyGroup(group: IInquiryGroup) {
  router.push({
    name: 'group',
    params: { id: group.id }
  })
}

async function deleteGroup(group: IInquiryGroup) {
  deleteDialogGroup.value = group
  showDeleteDialog.value = true
}

// Actual delete logic
async function performDeleteGroup(group: IInquiryGroup) {
  try {
    // Implement delete logic here
    // await inquiryGroupsStore.deleteGroup(group.id)
    showSuccess(t('agora', 'Group deleted successfully'))
    
    // Refresh groups
    // await inquiryGroupsStore.fetchAllGroups()
    
    // If we're in the deleted group's page, navigate to parent or home
    if (currentInquiryGroup.value?.id === group.id) {
      if (group.parentId) {
        const parent = inquiryGroupsStore.inquiryGroups.find(g => g.id === group.parentId)
        if (parent?.slug) {
          router.push({ name: 'group-list', params: { slug: parent.slug } })
        } else {
          navigateToHome()
        }
      } else {
        navigateToHome()
      }
    }
  } catch (error) {
    console.error('Error deleting group:', error)
    showError(t('agora', 'Failed to delete group'))
  }
}

function addAllowedResponse(group: InquiryGroup) {
  
  // Implement add allowed response logic
  console.log('Add response to group:', group.id)
  // This would typically open a dialog or navigate to a form
}

// Dialog handlers
function handleCloseGroupDialog() {
  createGroupDlgToggle.value = false
  selectedInquiryGroupTypeForCreation.value = null
}

function inquiryGroupAdded(newGroup: IInquiryGroup) {
  // Handle new group creation
  console.log('Group added:', newGroup)
  createGroupDlgToggle.value = false
  
  // Navigate to the new group
  if (newGroup.slug) {
    router.push({ name: 'group-list', params: { slug: newGroup.slug } })
  }
}

function handleGroupUpdate(updatedGroups: IInquiryGroup[]) {
  // Handle group selection updates
  console.log('Groups updated:', updatedGroups)
}

// Available groups for dialog (groups that can be selected as parents)
const availableGroups = computed(() => {
  return inquiryGroupsStore.inquiryGroups.filter(group => 
    group.id !== currentInquiryGroup.value?.id // Don't include current group
  )
})

// Selected groups for dialog (pre-selected in dialog)
const selectedGroups = computed(() => {
  if (currentInquiryGroup.value) {
    return [currentInquiryGroup.value.id]
  }
  return []
})

// Lifecycle
onMounted(async () => {
  try {
    // Load data if needed
    if (inquiryGroupsStore.inquiryGroups.length === 0) {
      // await inquiryGroupsStore.fetchAllGroups()
    }
    
    if (inquiriesStore.inquiries.length === 0) {
      // await inquiriesStore.fetchAll()
    }
    
    // Check if group exists when slug is provided
    if (hasSlug.value) {
      const slug = route.params.slug as string
      const group = inquiryGroupsStore.bySlug(slug)
      if (!group) {
        groupNotFound.value = true
      }
    }
  } catch (error) {
    console.error('Error loading data:', error)
    showError(t('agora', 'Failed to load data'))
  } finally {
    isLoading.value = false
  }
})

watch(() => route.params.slug, async () => {
  isLoading.value = true
  groupNotFound.value = false
  
  if (hasSlug.value) {
    const slug = route.params.slug as string
    const group = inquiryGroupsStore.bySlug(slug)
    if (!group) {
      groupNotFound.value = true
    }
  }
  
  isLoading.value = false
})
</script>

<style lang="scss" scoped>
.inquiry-group-page {
    width: 100%;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

/* Breadcrumb - smaller on left */
.breadcrumb-bar {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    padding: 15px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    border-bottom: 3px solid var(--color-primary, #2196f3);

    .breadcrumb-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        align-items: center;
        gap: 10px;

        .breadcrumb-home {
            color: white;
            font-weight: 600;
            font-size: 14px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: auto;

            &:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .breadcrumb-label {
                margin-left: 6px;
            }
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.6);
            margin: 0 3px;
            font-weight: 300;
            font-size: 16px;
        }

        .breadcrumb-item {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: 14px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            transition: all 0.3s ease;
            min-width: auto;

            &:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            .breadcrumb-item-content {
                display: flex;
                align-items: center;
                gap: 6px;
            }
        }

        .breadcrumb-current {
            color: white;
            font-weight: 700;
            font-size: 16px;
            margin-left: 3px;

            .breadcrumb-current-content {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 8px;
                border-left: 3px solid var(--color-primary, #2196f3);
            }

            .inquiry-count {
                font-weight: 400;
                font-size: 12px;
                opacity: 0.9;
                margin-left: 6px;
            }
        }

        .breadcrumb-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }
} 

/* White Separation Line */
.separation-line {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
    margin: 0;
}

/* Group Header */
.group-header {
    padding: 30px 20px 20px;
    background: white;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .group-icon-badge {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);

        .group-icon {
            width: 30px;
            height: 30px;
            color: white;
        }
    }

    .group-title-section {
        flex: 1;

        .group-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: #2c3e50;
            line-height: 1.2;
        }

        .group-subtitle {
            margin-top: 10px;

            p {
                color: #5d6d7e;
                font-size: 16px;
                line-height: 1.4;
                max-width: 800px;
                margin: 0 0 10px 0;
            }

            .inquiry-count-badge,
            .groups-count-badge {
                background: linear-gradient(135deg, #00b09b, #96c93d);
                color: white;
                padding: 6px 12px;
                border-radius: 15px;
                font-weight: 600;
                font-size: 13px;
                box-shadow: 0 2px 8px rgba(0, 176, 155, 0.3);
            }

            .groups-count-badge {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }
        }
    }
}

/* Loading State */
.loading-state {
    text-align: center;
    padding: 60px 20px;

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e0e6ed;
        border-top-color: #667eea;
        border-radius: 50%;
        margin: 0 auto 20px;
        animation: spin 1s linear infinite;
    }

    p {
        color: #5d6d7e;
        font-size: 16px;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Content Area */
.content-area {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 20px 40px;
}

/* Section Header */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;

    h3 {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .create-button {
        background: linear-gradient(135deg, #00b09b, #96c93d);
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 176, 155, 0.3);

        &:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 176, 155, 0.4);
        }
    }
}

/* Groups Grid */
.groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    align-items: start;
}

/* Container for vignette + menu */
.group-vignette-wrapper {
    position: relative;
    margin-bottom: 0;
}

.group-vignette {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 0, 0, 0.05);
    min-height: 320px;
    max-height: 380px;
    display: flex;
    flex-direction: column;
    height: 100%;

    &:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        border-color: var(--color-primary, #2196f3);

        .vignette-cover img {
            transform: scale(1.05);
        }
    }

    .vignette-cover {
        height: 120px;
        overflow: hidden;
        position: relative;

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .vignette-cover-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to top, rgba(0,0,0,0.2), transparent);
        }
    }

    .vignette-content {
        padding: 16px 20px;
        flex: 1;
        display: flex;
        flex-direction: column;

        .vignette-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            margin-bottom: 10px;
        }

        h4 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: #2c3e50;
            line-height: 1.3;
        }

        .vignette-description {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.3;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 0 0 auto;
        }

        .vignette-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;

            .stat-item {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 13px;

                .stat-icon {
                    opacity: 0.8;
                }

                .stat-value {
                    font-weight: 600;
                    color: #2c3e50;
                }
            }
        }

        .vignette-footer {
            margin-top: auto;

            .view-group-button {
                width: 100%;
                justify-content: center;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 8px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 12px;
                transition: all 0.3s ease;

                &:hover {
                    background: linear-gradient(135deg, #764ba2, #667eea);
                    transform: translateY(-1px);
                }
            }
        }
    }
}

/* Owner menu - appears under the vignette */
.owner-menu-under {
    position: absolute;
    top: 100%; /* Position it right below the vignette */
    left: 0;
    right: 0;
    background: white;
    border-radius: 0 0 15px 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    z-index: 5;
    overflow: hidden;
    border: 1px solid #e0e6ed;
    border-top: none;
    opacity: 0;
    transform: translateY(-5px); /* Reduced from -10px */
    transition: all 0.2s ease;
    pointer-events: none;
    margin-top: 2px; /* Small gap between vignette and menu */

    .group-vignette-wrapper:hover & {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    .owner-menu-content {
        display: flex;
        padding: 8px;
        gap: 6px;
        background: #f8fafc;

        .menu-item {
            flex: 1;
            justify-content: center;
            padding: 8px 6px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            min-height: 36px;
            white-space: nowrap;

            &:hover {
                background: #f1f5f9;
                color: #475569;
                border-color: #cbd5e1;
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

            &:active {
                transform: translateY(0);
            }

            :deep(svg) {
                margin-right: 6px;
                fill: #64748b;
            }

            &.modify:hover {
                color: #3b82f6;
                border-color: #93c5fd;
                :deep(svg) {
                    fill: #3b82f6;
                }
            }

            &.delete:hover {
                color: #ef4444;
                border-color: #fca5a5;
                :deep(svg) {
                    fill: #ef4444;
                }
            }

            &.add-response:hover {
                color: #10b981;
                border-color: #a7f3d0;
                :deep(svg) {
                    fill: #10b981;
                }
            }
        }
    }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 50px 20px;
    background: white;
    border-radius: 15px;
    border: 2px dashed #e0e6ed;

    .empty-icon {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    h3 {
        font-size: 20px;
        color: #2c3e50;
        margin: 0 0 10px 0;
    }

    p {
        color: #7f8c8d;
        margin-bottom: 25px;
        font-size: 15px;
    }
}

/* Not Found State */
.not-found-state {
    text-align: center;
    padding: 80px 20px;

    .not-found-icon {
        font-size: 60px;
        margin-bottom: 25px;
        opacity: 0.5;
    }

    h2 {
        font-size: 28px;
        color: #2c3e50;
        margin: 0 0 15px 0;
    }

    p {
        color: #7f8c8d;
        font-size: 16px;
        margin-bottom: 30px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .breadcrumb-bar {
        padding: 12px 0;

        .breadcrumb-container {
            padding: 0 15px;
            gap: 6px;

            .breadcrumb-home,
            .breadcrumb-item {
                font-size: 13px;
                padding: 6px 8px;
            }

            .breadcrumb-current {
                font-size: 14px;

                .breadcrumb-current-content {
                    padding: 6px 10px;
                }
            }
        }
    }

    .group-header {
        padding: 25px 15px 15px;

        .group-icon-badge {
            width: 50px;
            height: 50px;
            border-radius: 12px;

            .group-icon {
                width: 25px;
                height: 25px;
            }
        }

        .group-title {
            font-size: 22px;
        }
    }

    .content-area {
        padding: 0 15px 30px;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;

        h3 {
            font-size: 20px;
        }
    }

    .groups-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .owner-menu-under {
        .owner-menu-content {
            flex-direction: column;

            .menu-item {
                width: 100%;
                justify-content: flex-start;
                padding: 10px 12px;
            }
        }
    }
}
</style>
